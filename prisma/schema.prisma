generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  Admin
  Analyst
  Viewer
}

enum SourceType {
  news
  social
}

enum ContentState {
  active
  archived
  hidden
}

enum TermScope {
  claro
  competencia
}

enum RunStatus {
  queued
  running
  completed
  failed
}

enum TriggerType {
  scheduled
  manual
}

enum IncidentStatus {
  open
  acknowledged
  in_progress
  resolved
  dismissed
}

enum IncidentSeverity {
  SEV1
  SEV2
  SEV3
  SEV4
}

enum ReportRunStatus {
  queued
  running
  completed
  failed
  pending_review
}

enum ReportScheduleFrequency {
  daily
  weekly
}

enum AnalysisRunScope {
  overview
  channel
  competitors
  custom
}

enum NotificationRecipientKind {
  digest
  incident
}

model User {
  id              String               @id @default(uuid()) @db.Uuid
  email           String               @unique
  name            String?
  role            UserRole             @default(Viewer)
  isActive        Boolean              @default(true)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  stateEvents          ContentStateEvent[]
  audits               AuditLog[]
  overrides            Classification[] @relation("ClassificationOverride")
  exportJobs           ExportJob[]
  analysisRuns         AnalysisRun[]    @relation("AnalysisRunRequester")
  sourceWeightsUpdated SourceWeight[]   @relation("SourceWeightUpdater")
  notificationRecipientsUpdated NotificationRecipient[] @relation("NotificationRecipientUpdater")
  connectorSyncRuns    ConnectorSyncRun[]
  ownedIncidents       Incident[]       @relation("IncidentOwner")
  incidentNotes        IncidentNote[]   @relation("IncidentNoteAuthor")
  reportTemplates      ReportTemplate[] @relation("ReportTemplateCreator")
  reportSchedules      ReportSchedule[] @relation("ReportScheduleCreator")
  reportRuns           ReportRun[]      @relation("ReportRunRequester")

  @@index([role])
}

model TrackedTerm {
  id               String         @id @default(uuid()) @db.Uuid
  name             String
  language         String         @default("es")
  scope            TermScope      @default(claro)
  isActive         Boolean        @default(true)
  maxArticlesPerRun Int           @default(100)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  ingestionRuns    IngestionRun[]
  contentItems     ContentItem[]
  analysisRuns     AnalysisRun[]

  @@unique([name, language])
  @@index([isActive])
  @@index([scope])
}

model IngestionRun {
  id               String              @id @default(uuid()) @db.Uuid
  triggerType      TriggerType
  status           RunStatus           @default(queued)
  termId           String?             @db.Uuid
  language         String              @default("es")
  maxArticlesPerTerm Int               @default(100)
  requestId        String?
  startedAt        DateTime?
  finishedAt       DateTime?
  metrics          Json?
  errorMessage     String?
  createdAt        DateTime            @default(now())
  term             TrackedTerm?        @relation(fields: [termId], references: [id], onDelete: SetNull)
  items            IngestionRunItem[]
  contentLinks     IngestionRunContentLink[]

  @@index([status, createdAt])
  @@index([triggerType, createdAt])
}

model IngestionRunItem {
  id               String       @id @default(uuid()) @db.Uuid
  ingestionRunId   String       @db.Uuid
  provider         String
  status           RunStatus
  fetchedCount     Int          @default(0)
  persistedCount   Int          @default(0)
  latencyMs        Int?
  errorMessage     String?
  createdAt        DateTime     @default(now())
  ingestionRun     IngestionRun @relation(fields: [ingestionRunId], references: [id], onDelete: Cascade)

  @@index([ingestionRunId])
  @@index([provider, createdAt])
}

model ContentItem {
  id               String              @id @default(uuid()) @db.Uuid
  sourceType       SourceType
  termId           String?             @db.Uuid
  provider         String
  sourceName       String?
  sourceId         String?
  state            ContentState        @default(active)
  title            String
  summary          String?
  content          String?
  canonicalUrl     String
  imageUrl         String?
  language         String?
  category         String?
  publishedAt      DateTime?
  sourceScore      Decimal             @default(0.50) @db.Decimal(3, 2)
  rawPayloadS3Key  String?
  metadata         Json?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  term             TrackedTerm?        @relation(fields: [termId], references: [id], onDelete: SetNull)
  classifications  Classification[]
  stateEvents      ContentStateEvent[]
  analysisLinks    AnalysisRunItem[]
  ingestionLinks   IngestionRunContentLink[]

  @@unique([canonicalUrl])
  @@index([termId, publishedAt])
  @@index([state, createdAt])
  @@index([sourceType, provider])
  @@index([category])
}

model IngestionRunContentLink {
  id             String       @id @default(uuid()) @db.Uuid
  ingestionRunId String       @db.Uuid
  contentItemId  String       @db.Uuid
  canonicalUrl   String
  provider       String
  term           String
  createdAt      DateTime     @default(now())
  ingestionRun   IngestionRun @relation(fields: [ingestionRunId], references: [id], onDelete: Cascade)
  contentItem    ContentItem  @relation(fields: [contentItemId], references: [id], onDelete: Cascade)

  @@unique([ingestionRunId, canonicalUrl])
  @@unique([ingestionRunId, contentItemId])
  @@index([contentItemId])
  @@index([createdAt])
}

model Classification {
  id                String      @id @default(uuid()) @db.Uuid
  contentItemId     String      @db.Uuid
  categoria         String
  sentimiento       String
  etiquetas         Json?
  confianza         Decimal?    @db.Decimal(4, 3)
  promptVersion     String
  modelId           String
  isOverride        Boolean     @default(false)
  overriddenByUserId String?    @db.Uuid
  overrideReason    String?
  metadata          Json?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  contentItem       ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)
  overriddenByUser  User?       @relation("ClassificationOverride", fields: [overriddenByUserId], references: [id], onDelete: SetNull)

  @@unique([contentItemId, promptVersion, modelId])
  @@index([categoria, sentimiento])
  @@index([createdAt])
}

model AnalysisRun {
  id                String           @id @default(uuid()) @db.Uuid
  termId            String?          @db.Uuid
  scope             AnalysisRunScope @default(custom)
  status            RunStatus        @default(queued)
  triggerType       TriggerType      @default(manual)
  inputCount        Int              @default(0)
  sourceType        SourceType       @default(news)
  filters           Json?
  modelId           String
  promptVersion     String
  output            Json?
  requestId         String?
  requestedByUserId String?          @db.Uuid
  idempotencyKey    String?          @unique
  windowStart       DateTime
  windowEnd         DateTime
  errorMessage      String?
  startedAt         DateTime?
  completedAt       DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  term              TrackedTerm?     @relation(fields: [termId], references: [id], onDelete: SetNull)
  requestedByUser   User?            @relation("AnalysisRunRequester", fields: [requestedByUserId], references: [id], onDelete: SetNull)
  items             AnalysisRunItem[]

  @@index([status, createdAt])
  @@index([termId, createdAt])
  @@index([scope, createdAt])
  @@index([requestedByUserId, createdAt])
}

model AnalysisRunItem {
  id               String      @id @default(uuid()) @db.Uuid
  analysisRunId    String      @db.Uuid
  contentItemId    String      @db.Uuid
  createdAt        DateTime    @default(now())
  analysisRun      AnalysisRun @relation(fields: [analysisRunId], references: [id], onDelete: Cascade)
  contentItem      ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)

  @@unique([analysisRunId, contentItemId])
  @@index([contentItemId])
}

model ContentStateEvent {
  id               String       @id @default(uuid()) @db.Uuid
  contentItemId    String       @db.Uuid
  previousState    ContentState
  nextState        ContentState
  actorUserId      String       @db.Uuid
  reason           String?
  requestId        String?
  createdAt        DateTime     @default(now())
  contentItem      ContentItem  @relation(fields: [contentItemId], references: [id], onDelete: Cascade)
  actorUser        User         @relation(fields: [actorUserId], references: [id], onDelete: Restrict)

  @@index([contentItemId, createdAt])
  @@index([actorUserId, createdAt])
}

model SourceWeight {
  id               String    @id @default(uuid()) @db.Uuid
  provider         String
  sourceName       String?
  weight           Decimal   @db.Decimal(3, 2)
  isActive         Boolean   @default(true)
  updatedByUserId  String?   @db.Uuid
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  updatedByUser    User?     @relation("SourceWeightUpdater", fields: [updatedByUserId], references: [id], onDelete: SetNull)

  @@unique([provider, sourceName])
  @@index([provider])
}

model NotificationRecipient {
  id              String                   @id @default(uuid()) @db.Uuid
  kind            NotificationRecipientKind
  scope           String
  email           String
  isActive        Boolean                  @default(true)
  updatedByUserId String?                  @db.Uuid
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  updatedByUser   User?                    @relation("NotificationRecipientUpdater", fields: [updatedByUserId], references: [id], onDelete: SetNull)

  @@unique([kind, scope, email])
  @@index([kind, scope, isActive])
}

model AuditLog {
  id               String    @id @default(uuid()) @db.Uuid
  actorUserId      String?   @db.Uuid
  action           String
  resourceType     String
  resourceId       String?
  requestId        String?
  before           Json?
  after            Json?
  createdAt        DateTime  @default(now())
  actorUser        User?     @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([action, createdAt])
  @@index([resourceType, resourceId])
}

model ExportJob {
  id               String    @id @default(uuid()) @db.Uuid
  requestedByUserId String?  @db.Uuid
  status           RunStatus @default(queued)
  filters          Json?
  rowCount         Int       @default(0)
  s3Key            String?
  createdAt        DateTime  @default(now())
  completedAt      DateTime?
  requestedByUser  User?     @relation(fields: [requestedByUserId], references: [id], onDelete: SetNull)
  reportRuns       ReportRun[]

  @@index([status, createdAt])
}

model DigestRun {
  id               String    @id @default(uuid()) @db.Uuid
  digestDate       DateTime
  recipientScope   String
  status           RunStatus @default(queued)
  recipientsCount  Int       @default(0)
  s3Key            String?
  createdAt        DateTime  @default(now())
  completedAt      DateTime?

  @@unique([digestDate, recipientScope])
  @@index([status, createdAt])
}

model ReportTemplate {
  id                  String           @id @default(uuid()) @db.Uuid
  name                String
  description         String?
  isActive            Boolean          @default(true)
  sections            Json?
  filters             Json?
  confidenceThreshold Decimal          @default(0.650) @db.Decimal(4, 3)
  createdByUserId     String?          @db.Uuid
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  createdByUser       User?            @relation("ReportTemplateCreator", fields: [createdByUserId], references: [id], onDelete: SetNull)
  schedules           ReportSchedule[]
  runs                ReportRun[]

  @@unique([name])
  @@index([isActive, createdAt])
}

model ReportSchedule {
  id              String                  @id @default(uuid()) @db.Uuid
  templateId      String                  @db.Uuid
  name            String
  enabled         Boolean                 @default(true)
  frequency       ReportScheduleFrequency
  dayOfWeek       Int?
  timeLocal       String
  timezone        String                  @default("America/Bogota")
  recipients      Json?
  nextRunAt       DateTime
  lastRunAt       DateTime?
  createdByUserId String?                 @db.Uuid
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  template        ReportTemplate          @relation(fields: [templateId], references: [id], onDelete: Cascade)
  createdByUser   User?                   @relation("ReportScheduleCreator", fields: [createdByUserId], references: [id], onDelete: SetNull)
  runs            ReportRun[]

  @@index([enabled, nextRunAt])
  @@index([templateId, createdAt])
}

model ReportRun {
  id                String          @id @default(uuid()) @db.Uuid
  templateId        String          @db.Uuid
  scheduleId        String?         @db.Uuid
  status            ReportRunStatus @default(queued)
  windowStart       DateTime
  windowEnd         DateTime
  sourceType        SourceType      @default(news)
  confidence        Decimal?        @db.Decimal(4, 3)
  summary           Json?
  recommendations   Json?
  blockedReason     String?
  exportJobId       String?         @db.Uuid
  idempotencyKey    String?
  requestedByUserId String?         @db.Uuid
  createdAt         DateTime        @default(now())
  startedAt         DateTime?
  completedAt       DateTime?
  errorMessage      String?
  template          ReportTemplate  @relation(fields: [templateId], references: [id], onDelete: Restrict)
  schedule          ReportSchedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
  exportJob         ExportJob?      @relation(fields: [exportJobId], references: [id], onDelete: SetNull)
  requestedByUser   User?           @relation("ReportRunRequester", fields: [requestedByUserId], references: [id], onDelete: SetNull)

  @@unique([idempotencyKey])
  @@index([status, createdAt])
  @@index([templateId, createdAt])
  @@index([scheduleId, createdAt])
}

model ConnectorConfig {
  id               String             @id @default(uuid()) @db.Uuid
  provider         String             @unique
  enabled          Boolean            @default(true)
  frequencyMinutes Int                @default(15)
  healthStatus     String             @default("unknown")
  lastSyncAt       DateTime?
  lastError        String?
  latencyP95Ms     Int?
  metadata         Json?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  syncRuns         ConnectorSyncRun[]

  @@index([enabled, provider])
}

model ConnectorSyncRun {
  id                String          @id @default(uuid()) @db.Uuid
  connectorId       String          @db.Uuid
  status            RunStatus       @default(queued)
  startedAt         DateTime?
  finishedAt        DateTime?
  metrics           Json?
  errorMessage      String?
  triggeredByUserId String?         @db.Uuid
  createdAt         DateTime        @default(now())
  connector         ConnectorConfig @relation(fields: [connectorId], references: [id], onDelete: Cascade)
  triggeredByUser   User?           @relation(fields: [triggeredByUserId], references: [id], onDelete: SetNull)

  @@index([connectorId, createdAt])
  @@index([status, createdAt])
}

model OwnedAccount {
  id           String   @id @default(uuid()) @db.Uuid
  platform     String
  handle       String
  accountName  String
  businessLine String?
  macroRegion  String?
  language     String   @default("es")
  teamOwner    String?
  status       String   @default("active")
  campaignTags Json?
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([platform, handle])
  @@index([status, platform])
}

model Competitor {
  id        String   @id @default(uuid()) @db.Uuid
  brandName String   @unique
  aliases   Json?
  priority  Int      @default(3)
  status    String   @default("active")
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, priority])
}

model TaxonomyEntry {
  id          String   @id @default(uuid()) @db.Uuid
  kind        String
  key         String
  label       String
  description String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(100)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([kind, key])
  @@index([kind, isActive, sortOrder])
}

model Incident {
  id              String           @id @default(uuid()) @db.Uuid
  scope           TermScope
  severity        IncidentSeverity
  status          IncidentStatus   @default(open)
  riskScore       Decimal          @db.Decimal(5, 2)
  classifiedItems Int              @default(0)
  ownerUserId     String?          @db.Uuid
  slaDueAt        DateTime
  cooldownUntil   DateTime
  signalVersion   String
  payload         Json?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  resolvedAt      DateTime?
  ownerUser       User?            @relation("IncidentOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)
  notes           IncidentNote[]

  @@index([scope, status, createdAt])
  @@index([severity, status, createdAt])
  @@index([ownerUserId, status])
  @@index([cooldownUntil])
}

model IncidentNote {
  id           String   @id @default(uuid()) @db.Uuid
  incidentId   String   @db.Uuid
  authorUserId String   @db.Uuid
  note         String
  createdAt    DateTime @default(now())
  incident     Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  authorUser   User     @relation("IncidentNoteAuthor", fields: [authorUserId], references: [id], onDelete: Restrict)

  @@index([incidentId, createdAt])
  @@index([authorUserId, createdAt])
}

model IncidentEvaluationRun {
  id           String      @id @default(uuid()) @db.Uuid
  triggerType  TriggerType
  status       RunStatus   @default(queued)
  metrics      Json?
  errorMessage String?
  createdAt    DateTime    @default(now())
  finishedAt   DateTime?

  @@index([status, createdAt])
  @@index([triggerType, createdAt])
}
